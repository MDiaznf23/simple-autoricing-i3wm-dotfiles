;;-----------------------------------------------------
;; POLLING VARIABEL
;;-----------------------------------------------------

(defvar wifi_list_visible false)
(defvar audio_list_visible false)
(defvar bluetooth_list_visible false) 
(defvar control_center_visible false)

(defpoll wifi_networks :interval "5s"
  :initial "[]"
  :run-while wifi_list_visible  
  `~/.config/eww/scripts/scan_wifi.sh`)

(defpoll bluetooth_devices_listen :interval "2s"
  :initial "[]"
  :run-while bluetooth_list_visible 
  `~/.config/eww/scripts/scan_bluetooth.sh`)

;; Pindahkan bluetooth_status poll ke sini 
(defpoll bluetooth_status :interval "2s"
  :initial "no"
  :run-while control_center_visible
  `bluetoothctl show | grep "Powered:" | awk '{print $2}' || echo "no"`)

(defpoll wifi_status :interval "3s"
  :initial "disabled"
  :run-while control_center_visible
  `nmcli radio wifi || echo "disabled"`)

;; Poll untuk WiFi networks list
(defpoll wifi_ssid :interval "3s"
  :initial ""
  :run-while control_center_visible
  `nmcli -t -f active,ssid dev wifi | grep '^yes' | cut -d':' -f2 || echo "Not Connected"`)

;; Listener 1: Untuk Output (Speaker)
(deflisten list_outputs 
  :initial "[]"
  :run-while control_center_visible
  "python3 ~/.config/eww/scripts/get_audio_devices.py sink")

;; Listener 2: Untuk Input (Mic)
(deflisten list_inputs 
  :initial "[]"
  :run-while control_center_visible
  "python3 ~/.config/eww/scripts/get_audio_devices.py source")

;; Polls sistem
;; VOLUME LISTENER (Real-time)
(deflisten volume_level :initial "50"
  `~/.config/eww/scripts/get_volume_listen.sh`)

;; BRIGHTNESS LISTENER (Real-time)
(deflisten brightness_level :initial "50"
  `~/.config/eww/scripts/get_brightness_listen.sh`)

(defpoll night_mode_status :interval "2s"
  :initial "off"
  :run-while control_center_visible
  `[ -f /tmp/night_mode_status ] && cat /tmp/night_mode_status || echo "off"`)

;; Poll untuk Notifikasi (Dunst) - UPDATED
(defpoll notification_count :interval "2s"
  :initial "0"
  `dunstctl count history || echo 0`)

(defpoll notification_history :interval "2s"
  :initial "[]"
  :run-while control_center_visible
  `~/.config/eww/scripts/get_notifications.sh`)

;; CALENDAR
(defpoll DATE_HEADER :interval "30s" 
  "date +'%A, %d %B'")

(defpoll clock_time :interval "10s"
  "date +'%H:%M'")

(defpoll clock_date :interval "1h"
  "date +'%A, %B %d'")

;;---------------------------------------------------------
;; WIDGET CONTROL CENTER WINDOWS (UTAMA)
;;---------------------------------------------------------

;; ========================================
;; WIDGET BLUETOOTH ITEM (untuk list)
;; ========================================
(defwidget bluetooth_device_item [name mac connected paired type]
  (box :class "bt-device-item ${connected ? 'bt-connected' : ''}"       
       :orientation "h"
       :spacing 10
       :space-evenly false
    
    ;; Bagian KIRI - icon dan name
    (box :spacing 5
         :orientation "h"
         :space-evenly false
         :hexpand true        
         :halign "start"      
      
      ;; Type icon
      (label :class "bt-type-icon"
             :text {type == "phone" ? "Û∞Ñú " :
                    type == "headphone" ? "Û∞ãé " :
                    type == "computer" ? "Û∞à∏ " :
                    type == "keyboard" ? "Û∞åå " :
                    type == "mouse" ? "Û∞çΩ " : "Û∞ëñ "})
      
      ;; Device name
      (label :class "bt-name-label"
             :text name
             :xalign 0
             :limit-width 20))
    
    ;; Bagian KANAN - buttons
    (box :spacing 5
         :orientation "h"
         :space-evenly false
         :halign "end"        
      
      ;; Connect/Disconnect button
      (button :class "bt-action-btn"
              :onclick "~/.config/eww/scripts/connect_bluetooth.sh '${mac}' toggle && sleep 1"
        (label :text {connected ? "Û±òñ " : "Û±òñ "}))
      
      ;; Unpair button
      (button :class "bt-action-btn bt-unpair"
              :visible {paired}
              :onclick "~/.config/eww/scripts/connect_bluetooth.sh '${mac}' unpair && sleep 1"
        (label :text "x")))
  )
)

;; ========================================
;; WIDGET WIFI ITEM (untuk list)
;; ========================================
(defwidget wifi_network_item [ssid signal secured connected sig_icon sec_icon]
  (button :class "wifi-network-item ${connected == 'true' ? 'wifi-connected' : ''}"
          :onclick "~/.config/eww/scripts/connect_wifi.sh '${ssid}' &"
    (box :orientation "h"
         :spacing 10
         :space-evenly false
      
      ;; Signal icon
      (label :class "wifi-signal-icon"
             :text sig_icon)
      
      ;; SSID
      (label :class "wifi-ssid-label"
             :text ssid
             :xalign 0
             :limit-width 25
             :hexpand true)
      
      ;; Security icon
      (label :class "wifi-security-icon"
             :text sec_icon
             :visible {secured == "true"})
      
      ;; Connected indicator
      (label :class "wifi-connected-icon"
             :text "‚úì"
             :visible {connected == "true"})
    )
  )
)

;; ----------------------------------------
;; WIDGET TOGGLE
;; ----------------------------------------
(defwidget toggle_widget [icon label ?onclick ?active_class]
  (box :class "toggle-widget"
       :orientation "v"
       :spacing 0
       :valign "center"
       :halign "fill"
    
  (button :class "toggle-icon ${active_class}"
        :onclick {onclick != "" ? onclick : ""}
    (box :width 30 :height 30 :halign "center" :valign "center"
      (label :text icon :style "font-size: 20px;")
    )
  )

    (label :class "toggle-label"
           :text label
           :xalign 0.5 )  
  )
)

;; ----------------------------------------
;; WIDGET UNTUK SATU ITEM NOTIFIKASI - FIXED
;; ----------------------------------------
(defwidget notification_item [appname summary id icon_path]
  (box :class "notification-item"
       :orientation "h"
       :spacing 10
       :space-evenly false
    
    ;; Teks Notifikasi
    (box :class "notification-text-container"
         :orientation "v"
         :halign "start"
         :valign "center"
         :hexpand true
         :space-evenly false
      (label :class "notification-appname"
             :text appname
             :xalign 0
             :limit-width 35)
      (label :class "notification-summary"
             :text summary
             :xalign 0
             :wrap true
             :limit-width 35))
    
    ;; Button close yang berfungsi
    (button :class "notification-close-btn"
            :onclick "dunstctl history-rm ${id} && eww update notification_history=$(~/.config/eww/scripts/get_notifications.sh)"
      (label :text "‚úï"))
  )
)

;;======================================
;; Audio List Widget
;;======================================

(defwidget audio_menu []
  (revealer :reveal audio_list_visible
            :transition "slidedown"
            :duration "400ms"
    (box :orientation "v"
         :space-evenly false
         :class "audio-menu-container"
         :spacing 10
      
      ;; HEADER
      (box :orientation "h"
           :space-evenly false
           :spacing 10
        (button :class "back-btn"
                :onclick "eww update audio_list_visible=false"
                :halign "start"
          (label :text "ÔÅ† Back"))
        (label :text "Audio Settings"
               :halign "center"
               :hexpand true
               :class "section-title-header")
      )
      
      ;; OUTPUT SECTION
      (box :orientation "v"
           :space-evenly false
           :spacing 5
        (label :text "Output Devices"
               :class "section-title"
               :halign "start")
        (box :orientation "v"
             :spacing 3
          (for device in list_outputs
            (eventbox :onclick "pactl set-default-sink ${device.id}"
              (box :orientation "h"
                   :spacing 0 
                   :space-evenly false
                   :class "audio-item-container ${device.is_active ? 'active' : ''}"
                (label :class "audio-text" :halign "start" :hexpand true :text "${device.name}" :limit-width 28)
                (box :class "indicator-audio ${device.is_active ? 'active' : ''}" :halign "end")
              )
            )
          )
        )
      )
      
      ;; INPUT SECTION
      (box :orientation "v"
           :space-evenly false
           :spacing 5
        (label :text "Input Devices"
               :class "section-title"
               :halign "start")
        (box :orientation "v"
             :spacing 3
          (for device in list_inputs
            (eventbox :onclick "pactl set-default-source ${device.id}"
              (box :orientation "h" 
                   :spacing 0
                   :space-evenly false 
                   :class "audio-item-container ${device.is_active ? 'active' : ''}"
                (label :class "audio-text" :halign "start" :hexpand "true" :text "${device.name}" :limit-width 28)
                (box :class "indicator-audio ${device.is_active ? 'active' : ''}" :halign "end")
              )
            )
          )
        )
      )
    )
  )
)

;; ----------------------------------------
;; WIDGET QUICK TOGGLES (UPDATED)
;; ----------------------------------------
(defwidget quick_toggles []
  (box :class "quick-toggles-container"
       :orientation "v"
       :spacing -5
       :space-evenly false

    ;; --------------------------------------------------------
    ;; 3 toggle buttons (WiFi, BT, Night)
    ;; --------------------------------------------------------
    (box :class "quick-toggles-row"
         :orientation "h"
         :spacing 10
         :halign "fill"
         :valign "center"
         :space-evenly true

      ;; 1. WiFi - ONCLICK TOGGLE EXPAND
      (toggle_widget :icon {wifi_status == "enabled" ? "Ôá´ " : "Ôñ¨"}
                     :label {wifi_status == "enabled" ? "On" : "Off"}
                     :onclick "eww update bluetooth_list_visible=false wifi_list_visible=${!wifi_list_visible}"
                     :active_class {wifi_status == "enabled" ? "wifi-active" : ""})

      ;; 2. Bluetooth Mode
      (toggle_widget :icon {bluetooth_status == "yes" ? "Û∞ÇØ" : "Û∞Ç≤"}
                     :label {bluetooth_status == "yes" ? "On" : "Off"}
                     :onclick "eww update wifi_list_visible=false bluetooth_list_visible=${!bluetooth_list_visible}"
                     :active_class {bluetooth_status == "yes" ? "bt-active" : ""})

      ;; 3. Night Mode (UPDATED)
      (toggle_widget :icon "üåô"
                     :label {night_mode_status == "on" ? "On" : "Off"}
                     :onclick "~/.config/eww/scripts/toggle_night_mode.sh"
                     :active_class {night_mode_status == "on" ? "night-active" : ""})
    )

    ;; --------------------------------------------------------
    ;; EXPANDABLE WIFI LIST
    ;; --------------------------------------------------------
    (revealer :reveal wifi_list_visible
              :transition "slidedown"
              :duration "400ms"
      (box :class "wifi-expanded-panel"
           :orientation "v"
           :spacing 0
           :space-evenly false
        
        ;; Header WiFi (Power Toggle & Scan)
        (box :orientation "h"
             :spacing 0
             :space-evenly false
             :class "wifi-panel-container"

          ;; WiFi Power Toggle Wrapper
          (box :orientation "h"
               :spacing 0
               :vexpand false
               :valign "center"
               :space-evenly false
               :halign "start"
            (button :class "wifi-power-toggle"
                    :onclick "~/.config/eww/scripts/toggle_wifi.sh && sleep 1 && eww update wifi_networks=$(~/.config/eww/scripts/scan_wifi.sh)"
              (stack :selected {wifi_status == "enabled" ? 0 : 1}
                     :transition "slideleft"
                     :same-size true

                ;; Index 0: Tampilan saat ON
                (box :class "toggle-content on"
                     :orientation "h"
                     :space-evenly false
                     :spacing 8
                     :halign "end"
                  (label :text "")
                  (box :vexpand false
                       :valign "center"
                       :class "circle-indicator-on"))

                ;; Index 1: Tampilan saat OFF
                (box :class "toggle-content off"
                     :orientation "h"
                     :space-evenly false
                     :spacing 8
                     :halign "start"
                  (box :vexpand false
                       :valign "center"
                       :class "circle-indicator-off")
                  (label :text ""))
              )
            )
          )
          
          (box :vexpand false
               :valign "center"
               :hexpand true
              (separator))

          ;; Scan button WiFi
          (box :class "wifi-scan-container"
               :orientation "h"
               :space-evenly false
               :halign "end"
               :vexpand false
               :valign "center"
            (button :class "wifi-scan-btn"
                    :onclick "eww update wifi_networks=$(~/.config/eww/scripts/scan_wifi.sh)"
              (label :text "Ôã± ")))
        )

        ;; Networks list
        (scroll :class "wifi-networks-scroll"
                :height 180
                :vscroll true
                :hscroll false
          (box :orientation "v"
               :spacing 3
               :space-evenly false

            ;; Loop through networks
            (for network in wifi_networks
              (wifi_network_item :ssid {network.ssid}
                                 :signal {network.signal}
                                 :secured {network.secured}
                                 :connected {network.connected}
                                 :sig_icon {network.sig_icon}
                                 :sec_icon {network.sec_icon}))

            ;; No networks message
            (label :class "wifi-no-networks"
                   :text "No networks found"
                   :visible {wifi_networks == "[]" || wifi_status != "enabled"})
          )
        )
      )
    )

    ;; --------------------------------------------------------
    ;; EXPANDABLE BLUETOOTH LIST
    ;; --------------------------------------------------------
    (revealer :reveal bluetooth_list_visible
              :transition "slidedown"
              :duration "400ms"
      (box :class "bt-expanded-panel"
           :orientation "v"
           :spacing 0
           :space-evenly false

        ;; Wrapper Header Bluetooth
        (box :orientation "h"
             :spacing 0
             :class "bt-panel-container"
             :space-evenly false

          ;; Bluetooth Power Toggle Wrapper
          (box :spacing 0
               :vexpand false
               :valign "center"
               :orientation "h"
               :space-evenly false
               :halign "start"
            (button :class "bt-power-toggle"
                    :onclick "~/.config/eww/scripts/toggle_bluetooth.sh && sleep 1 && eww update bluetooth_devices=$(~/.config/eww/scripts/scan_bluetooth.sh)"
              (stack :selected {bluetooth_status == "yes" ? 0 : 1}
                     :transition "slideleft"
                     :same-size true

                ;; Index 0: Tampilan saat ON
                (box :class "toggle-content on"
                     :orientation "h"
                     :space-evenly false
                     :spacing 8
                     :halign "end"
                  (label :text "")
                  (box :vexpand false
                       :valign "center"
                       :class "circle-indicator-on"))

                ;; Index 1: Tampilan saat OFF
                (box :class "toggle-content off"
                     :orientation "h"
                     :space-evenly false
                     :spacing 8
                     :halign "start"
                  (box :vexpand false
                       :valign "center"
                       :class "circle-indicator-off")
                  (label :text ""))
              )
            )
          )

          (box :vexpand false
               :valign "center"
               :hexpand true
              (separator))

          ;; Scan button Bluetooth (Container Wrapper)
          (box :class "bt-scan-container"
               :orientation "h"
               :space-evenly false
               :halign "end"
               :vexpand false
               :valign "center"
            (button :class "bt-scan-btn"
                    :onclick "eww update bluetooth_devices_listen=$(~/.config/eww/scripts/scan_bluetooth.sh)"
              (label :text "Ôã± ")))
        )

        ;; Devices list
        (scroll :class "bt-devices-scroll"
                :height 180
                :vscroll true
                :hscroll false
          (box :orientation "v"
               :spacing 3
               :space-evenly false

            ;; Loop through devices
            (for device in bluetooth_devices_listen
              (bluetooth_device_item :name {device.name}
                                     :mac {device.mac}
                                     :connected {device.connected}
                                     :paired {device.paired}
                                     :type {device.type}))

            ;; No devices message
            (label :class "bt-no-devices"
                   :text "No devices found"
                   :visible {bluetooth_devices_listen == "[]" || bluetooth_status != "yes"})
          )
        )
      )
    )
  )
)

;; ----------------------------------------
;; WIDGET UNTUK PUSAT NOTIFIKASI - FIXED
;; ----------------------------------------
(defwidget notification_center []
  (box :class "notification-center-container"
       :orientation "v"
       :space-evenly false
       :spacing 0
    
    ;; Header Notifikasi - FIXED
    (box :class "notification-header"
         :orientation "h"
         :space-evenly false
         :hexpand true
      (label :class "notification-header-title"
             :text "Notifications"
             :halign "start"
             :hexpand true)
      (button :class "clear-all-btn"
              :onclick "dunstctl history-clear && eww update notification_history='[]'"
        (label :xalign 1 :text "Clear")))
    
    (separator)
    
    ;; Daftar Notifikasi (dengan scroll)
    (scroll :class "notification-list-scroll"
            :height 150
            :vscroll true
            :hscroll false
      (box :class "notification-list"
           :orientation "v"
           :spacing 8
           :valign {notification_count == 0 ? "center" : "start"}
           :vexpand true
           ;; Loop melalui hasil script
           (for notification in notification_history
             (notification_item
                 :appname {notification.appname}
                 :summary {notification.summary}
                 :id {notification.id}
                 :icon_path {notification.icon}
             )
           )
           
           ;; Footer di DALAM scroll - tampil saat tidak ada notifikasi
           (box :class "notification-footer"
                :halign "center"
                :valign "center"
                :vexpand true
                :visible {notification_count == 0}
             (label :text "No new notifications"))
      )
    )
  )
)

;; ----------------------------------------
;; WIDGET SEPARATOR
;; ----------------------------------------
(defwidget separator []
  (box :class "separator" :hexpand true))

;; ----------------------------------------
;; WIDGET SLIDER
;; ----------------------------------------
(defwidget slider_row [icon_left value onchange]
  (box :class "slider-row" 
       :spacing 8
       :hexpand true
       :space-evenly false
       :valign "center"
    (label :class "slider-icon" :text icon_left)
    (scale :class "system-slider"
           :min 0
           :max 101
           :value value
           :orientation "h"
           :onchange onchange
           :hexpand true)
    (label :class "slider-percentage"
           :text "${value}%"
           :style "min-width: 35px;")
  )
)

;; ----------------------------------------
;; WIDGET CONTROL CENTER UTAMA
;; ----------------------------------------
(defwidget control_center []
  (box :class "control-center-container"
       :orientation "v"
       :spacing 0
       :space-evenly false
       :valign "start"

    ;; ------------------------------------------------------------
    ;; 1. AUDIO MENU PAGE
    ;; if audio_list_visible = true
    ;; ------------------------------------------------------------
    (audio_menu)

    ;; ------------------------------------------------------------
    ;; 2. MAIN PAGE (Toggles, Sliders, Notifs)
    ;; hide if audio_list_visible = true
    ;; ------------------------------------------------------------
    (revealer :reveal {!audio_list_visible}
              :transition "slideup"
              :duration "400ms"
      
      ;; !!! PENTING: Box ini adalah SATU-SATUNYA anak dari revealer !!!
      (box :orientation "v"
           :spacing 0
           :space-evenly false

        ;; A. Quick Toggles
        (quick_toggles)

        ;; B. Separator
        (revealer :reveal {!wifi_list_visible && !bluetooth_list_visible}
                  :transition "slideup"
                  :duration "200ms"
          (separator))

        ;; C. Sliders
        (revealer :reveal {!wifi_list_visible && !bluetooth_list_visible}
                  :transition "slideup"
                  :duration "200ms"
          (box :class "sliders-container"
               :orientation "v"
               :spacing 0
               :space-evenly false

            ;; Brightness
            (slider_row :icon_left "Û∞Éû "
                        :value brightness_level
                        :onchange "~/.config/i3/brightness.sh set {}")
            
            (box :orientation "h"
                 :vexpand false
                 :valign "center"
                 :space-evenly false
                 :spacing 0
              (slider_row :icon_left "Û∞ïæ "
                          :value volume_level
                          :onchange "pactl set-sink-volume @DEFAULT_SINK@ {}%")
              (box :spacing 0
                (button :class "audio-toggle-container"
                        :vexpand false
                        :valign "center"
                        :onclick "eww update audio_list_visible=true" "Û∞íì ")))
          )
        )

        ;; D. Separator
        (revealer :reveal {!wifi_list_visible && !bluetooth_list_visible}
                  :transition "slideup"
                  :duration "200ms"
          (separator))

        ;; E. Notification Center
        (revealer :reveal {!wifi_list_visible && !bluetooth_list_visible}
                  :transition "slideup"
                  :duration "400ms"
          (notification_center))
      
      ) ;; child revealer
    )   ;; main revealer 
  )     ;; container box
)       ;; defwidget

;; ----------------------------------------
;; JENDELA UTAMA
;; ----------------------------------------
(defwindow control_center_window
  :monitor 0
  :geometry (geometry :x "-80px" :y "45px" :anchor "top right")
  :stacking "overlay"
  :exclusive false
  :focusable false
  :windowtype "dialog"
  :wm-ignore false
  (control_center))               

